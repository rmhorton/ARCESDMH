Chapter 10: Markov models
================
Bob
2025-04-29

Copied from `Chapter_10.Rmd`.

# Example 10.2 revisited (p 203)

``` r
model_code <- "
model{
  for (tmt in 1:2) {    # tmt: 1=Seretide, 2=Fluticasone
    for (i in 1:4){     # four non-absorbing states
      r[tmt, i, 1:5] ~ dmulti(pi[tmt, i, 1:5], n[tmt, i]) # multinomial data
      pi[tmt, i, 1:5] ~ ddirch(prior[tmt, i, 1:5])        # Dirichlet prior
    }
  }
}
"

# We need to do some munging to create an R data structure with the
# correct dimensions. First we make an R version of the `r` 3d array,
# using the data as it is printed in the text:
rr=structure(
  .Data=c(                    # Seretide
    210,     60,    0,  1,   1,   # Row 1 (STW)
     88,    641,    0,  4,  13,   # Row 2 (UTW)
      0,        0,  0,  0,   0,   # Row 3 (Hex)
      1,        0,  0,  0,   1,   # Row 4 (Pex)
    
                              # Fluticasone
     66,   32,  0,  0,   2,   # Row 1 (STW)
     42,  752,  0,  5,  20,   # Row 2 (UTW)
      0,    0,  0,  0,   0,   # Row 3 (Hex)
      0,    4,  0,  1,   0    # Row 4 (Pex)
    ), 
    .Dim=c(5,4,2)             # Matrix dimensions # 2,4,5
)

# The Seretide matrix is t(r[,,1]), and the Fluticasone matrix is t(r[,,2])

# Now we need to shift the values around to the arrangement JAGS expects. 
# Start with a 3d array full of placeholder values:
jr <- structure(
  .Data=rep(-1, 2*4*5),     # -1 can't really happen
  .Dim=c(2,4,5)             # Matrix dimensions
)

# Now copy in the numbers from the R array:
for (tmt in 1:2){
  for (i in 1:4){
    for (j in 1:5){
      jr[tmt, i, j] <- rr[j, i, tmt]
    }
  }
}

## The row totals need to be swapped and flipped (row major order) to match the `r` array.
## Since this is 2d data we can just use a matrix:
jn <- matrix(
    c(272,746,0,2,
      100,819,0,5),
    nrow=2, byrow=TRUE
)

prior <- structure(           # Dirichlet priors all = 1
  .Data=rep(1, 2*4*5), 
    .Dim=c(2,4,5)
)
```

Work problem in `Stan`. Methods taken from
<https://github.com/WinVector/Examples/blob/main/MetaAnalysis/Amlodipine/ExaminingMetaAnalysis.qmd>
.

``` r
library(rstan)
library(jsonlite)
```

``` r
stan_code <- "
data {
  int<lower=1> nt;  // treatments: 1=Seretide, 2=Fluticasone
  int<lower=1> ni;  // four non-absorbing states (sources)
  int<lower=1> nj;  // five overall states (destinations)
  array[nt, ni, nj] int<lower=0> r;
  array[nt, ni] vector<lower=0>[nj] prior;
}
parameters {
  array[nt, ni] simplex[nj] pi;
}
model {
  for (tmt in 1:nt) {    // tmt: 1=Seretide, 2=Fluticasone
    for (i in 1:ni) {    // four non-absorbing states
        r[tmt, i, ] ~ multinomial(pi[tmt, i]);    // multinomial data, total infferred from LHS
        pi[tmt, i] ~ dirichlet(prior[tmt, i]);    // Dirichlet prior
    }
  }
}
"
```

``` r
stan_data <- list(
  nt = dim(jr)[[1]],
  ni = dim(jr)[[2]],
  nj = dim(jr)[[3]],
  r = array(jr, dim = dim(jr)),  # make sure array so shape info goes through JSON correctly
  prior = array(prior, dim = dim(prior))
)
```

``` r
sample <- stan(
  model_code = stan_code,  # Stan program
  data = stan_data,           # named list of data
  chains = 4,                 # number of Markov chains, 1 to debug
  warmup = 2000,              # number of warmup iterations per chain
  iter = 4000,                # total number of iterations per chain
  cores = 4,                  # number of cores (could use one per chain)
  refresh = 0,                # no progress shown
)
```

``` r
sample
```

    ## Inference for Stan model: anon_model.
    ## 4 chains, each with iter=4000; warmup=2000; thin=1; 
    ## post-warmup draws per chain=2000, total post-warmup draws=8000.
    ## 
    ##               mean se_mean   sd     2.5%      25%      50%      75%    97.5%
    ## pi[1,1,1]     0.76    0.00 0.03     0.71     0.74     0.76     0.78     0.81
    ## pi[1,1,2]     0.22    0.00 0.02     0.17     0.20     0.22     0.24     0.27
    ## pi[1,1,3]     0.00    0.00 0.00     0.00     0.00     0.00     0.01     0.01
    ## pi[1,1,4]     0.01    0.00 0.00     0.00     0.00     0.01     0.01     0.02
    ## pi[1,1,5]     0.01    0.00 0.01     0.00     0.00     0.01     0.01     0.02
    ## pi[1,2,1]     0.12    0.00 0.01     0.10     0.11     0.12     0.13     0.14
    ## pi[1,2,2]     0.86    0.00 0.01     0.83     0.85     0.85     0.86     0.88
    ## pi[1,2,3]     0.00    0.00 0.00     0.00     0.00     0.00     0.00     0.00
    ## pi[1,2,4]     0.01    0.00 0.00     0.00     0.00     0.01     0.01     0.01
    ## pi[1,2,5]     0.02    0.00 0.00     0.01     0.02     0.02     0.02     0.03
    ## pi[1,3,1]     0.20    0.00 0.16     0.01     0.07     0.16     0.30     0.60
    ## pi[1,3,2]     0.20    0.00 0.16     0.01     0.07     0.16     0.29     0.60
    ## pi[1,3,3]     0.20    0.00 0.16     0.01     0.07     0.16     0.30     0.60
    ## pi[1,3,4]     0.20    0.00 0.16     0.01     0.07     0.16     0.29     0.59
    ## pi[1,3,5]     0.20    0.00 0.16     0.01     0.07     0.16     0.29     0.60
    ## pi[1,4,1]     0.28    0.00 0.16     0.04     0.16     0.26     0.39     0.64
    ## pi[1,4,2]     0.14    0.00 0.12     0.01     0.05     0.11     0.21     0.45
    ## pi[1,4,3]     0.14    0.00 0.12     0.00     0.05     0.11     0.21     0.45
    ## pi[1,4,4]     0.14    0.00 0.12     0.00     0.05     0.11     0.20     0.46
    ## pi[1,4,5]     0.29    0.00 0.16     0.04     0.17     0.27     0.39     0.64
    ## pi[2,1,1]     0.64    0.00 0.05     0.54     0.61     0.64     0.67     0.73
    ## pi[2,1,2]     0.31    0.00 0.05     0.23     0.28     0.31     0.34     0.41
    ## pi[2,1,3]     0.01    0.00 0.01     0.00     0.00     0.01     0.01     0.03
    ## pi[2,1,4]     0.01    0.00 0.01     0.00     0.00     0.01     0.01     0.03
    ## pi[2,1,5]     0.03    0.00 0.02     0.01     0.02     0.03     0.04     0.07
    ## pi[2,2,1]     0.05    0.00 0.01     0.04     0.05     0.05     0.06     0.07
    ## pi[2,2,2]     0.91    0.00 0.01     0.89     0.91     0.91     0.92     0.93
    ## pi[2,2,3]     0.00    0.00 0.00     0.00     0.00     0.00     0.00     0.00
    ## pi[2,2,4]     0.01    0.00 0.00     0.00     0.01     0.01     0.01     0.01
    ## pi[2,2,5]     0.03    0.00 0.01     0.02     0.02     0.03     0.03     0.04
    ## pi[2,3,1]     0.20    0.00 0.16     0.01     0.07     0.16     0.30     0.61
    ## pi[2,3,2]     0.20    0.00 0.16     0.01     0.07     0.16     0.30     0.60
    ## pi[2,3,3]     0.20    0.00 0.16     0.01     0.07     0.16     0.29     0.60
    ## pi[2,3,4]     0.20    0.00 0.16     0.01     0.07     0.16     0.29     0.59
    ## pi[2,3,5]     0.20    0.00 0.17     0.01     0.07     0.16     0.29     0.61
    ## pi[2,4,1]     0.10    0.00 0.09     0.00     0.03     0.07     0.14     0.34
    ## pi[2,4,2]     0.50    0.00 0.15     0.21     0.39     0.50     0.61     0.79
    ## pi[2,4,3]     0.10    0.00 0.09     0.00     0.03     0.07     0.15     0.33
    ## pi[2,4,4]     0.20    0.00 0.12     0.03     0.11     0.18     0.27     0.49
    ## pi[2,4,5]     0.10    0.00 0.09     0.00     0.03     0.08     0.14     0.34
    ## lp__      -1007.71    0.08 4.39 -1017.20 -1010.42 -1007.33 -1004.64 -1000.09
    ##           n_eff Rhat
    ## pi[1,1,1]  9812    1
    ## pi[1,1,2]  9844    1
    ## pi[1,1,3]  8217    1
    ## pi[1,1,4]  8902    1
    ## pi[1,1,5]  9144    1
    ## pi[1,2,1]  9853    1
    ## pi[1,2,2] 10402    1
    ## pi[1,2,3] 10785    1
    ## pi[1,2,4]  9296    1
    ## pi[1,2,5]  9706    1
    ## pi[1,3,1] 11469    1
    ## pi[1,3,2] 10082    1
    ## pi[1,3,3] 10651    1
    ## pi[1,3,4]  9215    1
    ## pi[1,3,5]  9314    1
    ## pi[1,4,1]  9425    1
    ## pi[1,4,2] 10026    1
    ## pi[1,4,3] 11546    1
    ## pi[1,4,4]  9618    1
    ## pi[1,4,5]  8902    1
    ## pi[2,1,1] 10284    1
    ## pi[2,1,2] 10507    1
    ## pi[2,1,3]  9607    1
    ## pi[2,1,4]  9351    1
    ## pi[2,1,5] 10325    1
    ## pi[2,2,1] 11203    1
    ## pi[2,2,2] 11063    1
    ## pi[2,2,3] 10771    1
    ## pi[2,2,4]  9276    1
    ## pi[2,2,5] 11358    1
    ## pi[2,3,1] 12654    1
    ## pi[2,3,2] 11825    1
    ## pi[2,3,3] 10125    1
    ## pi[2,3,4]  9232    1
    ## pi[2,3,5]  9659    1
    ## pi[2,4,1] 11648    1
    ## pi[2,4,2] 10284    1
    ## pi[2,4,3]  9928    1
    ## pi[2,4,4]  9389    1
    ## pi[2,4,5]  8725    1
    ## lp__       3074    1
    ## 
    ## Samples were drawn using NUTS(diag_e) at Wed May 21 13:52:54 2025.
    ## For each parameter, n_eff is a crude measure of effective sample size,
    ## and Rhat is the potential scale reduction factor on split chains (at 
    ## convergence, Rhat=1).

``` r
sample |>
  as.data.frame() |>
  head() |>
  knitr::kable()
```

| pi\[1,1,1\] | pi\[2,1,1\] | pi\[1,2,1\] | pi\[2,2,1\] | pi\[1,3,1\] | pi\[2,3,1\] | pi\[1,4,1\] | pi\[2,4,1\] | pi\[1,1,2\] | pi\[2,1,2\] | pi\[1,2,2\] | pi\[2,2,2\] | pi\[1,3,2\] | pi\[2,3,2\] | pi\[1,4,2\] | pi\[2,4,2\] | pi\[1,1,3\] | pi\[2,1,3\] | pi\[1,2,3\] | pi\[2,2,3\] | pi\[1,3,3\] | pi\[2,3,3\] | pi\[1,4,3\] | pi\[2,4,3\] | pi\[1,1,4\] | pi\[2,1,4\] | pi\[1,2,4\] | pi\[2,2,4\] | pi\[1,3,4\] | pi\[2,3,4\] | pi\[1,4,4\] | pi\[2,4,4\] | pi\[1,1,5\] | pi\[2,1,5\] | pi\[1,2,5\] | pi\[2,2,5\] | pi\[1,3,5\] | pi\[2,3,5\] | pi\[1,4,5\] | pi\[2,4,5\] | lp\_\_ |
|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| 0.8055243 | 0.6238358 | 0.1207692 | 0.0730419 | 0.1386072 | 0.0730299 | 0.1662350 | 0.1223349 | 0.1770369 | 0.3442844 | 0.8352453 | 0.8981999 | 0.1773057 | 0.3853094 | 0.3086378 | 0.4631106 | 0.0086185 | 0.0052659 | 0.0039998 | 0.0004569 | 0.0092134 | 0.2692774 | 0.0063860 | 0.1377361 | 0.0020801 | 0.0123014 | 0.0224075 | 0.0033242 | 0.3535259 | 0.1440817 | 0.3627000 | 0.0477286 | 0.0067402 | 0.0143124 | 0.0175781 | 0.0249771 | 0.3213479 | 0.1283016 | 0.1560412 | 0.2290898 | -1014.598 |
| 0.7757909 | 0.6651594 | 0.1160492 | 0.0544054 | 0.1786208 | 0.0299286 | 0.2787460 | 0.1430419 | 0.2148865 | 0.3201503 | 0.8582645 | 0.9147941 | 0.0820954 | 0.1760985 | 0.3746831 | 0.5100695 | 0.0020396 | 0.0030283 | 0.0006865 | 0.0000608 | 0.0009011 | 0.1878136 | 0.0133583 | 0.0159639 | 0.0034563 | 0.0035595 | 0.0073990 | 0.0058573 | 0.2536503 | 0.1730858 | 0.1414477 | 0.0927162 | 0.0038267 | 0.0081026 | 0.0176008 | 0.0248824 | 0.4847324 | 0.4330735 | 0.1917649 | 0.2382085 | -1006.942 |
| 0.7948771 | 0.6829770 | 0.1251781 | 0.0496395 | 0.2160921 | 0.0967443 | 0.0885428 | 0.0790073 | 0.1956969 | 0.2360403 | 0.8569617 | 0.9101689 | 0.0843680 | 0.1119049 | 0.0391788 | 0.4871333 | 0.0006383 | 0.0090700 | 0.0015088 | 0.0001543 | 0.3743579 | 0.0478563 | 0.3472371 | 0.2388717 | 0.0055073 | 0.0137551 | 0.0038202 | 0.0071165 | 0.1247080 | 0.0077423 | 0.1973669 | 0.1888587 | 0.0032803 | 0.0581576 | 0.0125312 | 0.0329208 | 0.2004740 | 0.7357522 | 0.3276742 | 0.0061289 | -1008.089 |
| 0.7820951 | 0.7088074 | 0.1299767 | 0.0573621 | 0.0316882 | 0.0285957 | 0.2399246 | 0.1117888 | 0.2088272 | 0.2521508 | 0.8361175 | 0.9138577 | 0.4118818 | 0.8054568 | 0.3475527 | 0.4171628 | 0.0041348 | 0.0154266 | 0.0014757 | 0.0023148 | 0.2385941 | 0.0040325 | 0.0201407 | 0.0362597 | 0.0026956 | 0.0050138 | 0.0056756 | 0.0052067 | 0.1171632 | 0.0663030 | 0.1485847 | 0.2439414 | 0.0022472 | 0.0186015 | 0.0267544 | 0.0212588 | 0.2006727 | 0.0956120 | 0.2437973 | 0.1908473 | -1006.436 |
| 0.7572425 | 0.6570370 | 0.1215315 | 0.0468040 | 0.5706773 | 0.1832716 | 0.4064155 | 0.0994240 | 0.2010177 | 0.3018207 | 0.8620571 | 0.9100124 | 0.0115653 | 0.0834649 | 0.0135738 | 0.5172932 | 0.0018604 | 0.0037681 | 0.0003045 | 0.0005761 | 0.1672677 | 0.6003148 | 0.3721206 | 0.2095769 | 0.0124237 | 0.0119371 | 0.0031113 | 0.0111864 | 0.0795093 | 0.0263998 | 0.0697782 | 0.1651467 | 0.0274557 | 0.0254371 | 0.0129956 | 0.0314212 | 0.1709803 | 0.1065488 | 0.1381120 | 0.0085591 | -1008.780 |
| 0.7641699 | 0.5362893 | 0.1230567 | 0.0548104 | 0.0101779 | 0.0774754 | 0.0761233 | 0.1565154 | 0.2175728 | 0.4290659 | 0.8457856 | 0.9010162 | 0.4349188 | 0.0787457 | 0.2732626 | 0.7011132 | 0.0040517 | 0.0133297 | 0.0017896 | 0.0016518 | 0.0862444 | 0.0604047 | 0.0734834 | 0.0179321 | 0.0119742 | 0.0043059 | 0.0120168 | 0.0081647 | 0.4029426 | 0.3489345 | 0.1234240 | 0.0842687 | 0.0022315 | 0.0170092 | 0.0173512 | 0.0343568 | 0.0657163 | 0.4344398 | 0.4537067 | 0.0401706 | -1006.435 |
