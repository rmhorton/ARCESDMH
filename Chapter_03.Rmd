---
title: 'Chapter 3: Introduction to Decision Models'
author: "Bob"
date: "2025-03-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries, warn=FALSE, message=FALSE}
library('jagsUI')     # wrapper for rjags
library('mcmcplots')  # caterplot
library('coda')
library('dplyr')
```

# Deterministic decision tree

This is the model at the end of section 3.4 (p 56). The expected costs of the treament and control branches match those in the text on p56.

<font color="#FF0000">
Note that the text mentions 3 doses (Table 3.3, p 55), but this code appears to only charge for one dose.
The stochastic model below charges for 3 doses.
</font>

```{r deterministic_decision_tree}

model_code <- "
model {
  cost_nwdpx <- losnwd * cstnwd + dose * (cstPx + cstadmin) # Cost (No infection/Px)
  cost_wdpx <- loswd * cstwd + dose * (cstPx + cstadmin)    # Cost (Infection/Px)
  cost_nwd <- losnwd * cstnwd                               # Cost (No infection/no Px)
  cost_wd <- loswd * cstwd                                  # Cost (Infection/no Px)
  
  RR <- (a/(a+b))/(c/(c+d))                                 # Relative risk using 
                                                            # data from table 3.2
                                                            
  p1 <- rc1/nc1
  p2 <- RR * p1
  
  costtrt <- ((1-p2) * cost_nwdpx) + p2 * cost_wdpx         # Total cost (payoff) Px
  costctl <- ((1-p1) * cost_nwd) + p1*cost_wd              # Total cost (payoff) No Px

}" %>% textConnection

data <- list(
  losnwd=6.7,
  loswd=8.8,
  cstnwd=107.26,
  cstwd=163.03,
  # cstdrug=5.67,  # Warning: Unused variable "cstdrug"
  cstPx=5.67,  # !!! `cstdrug` should be `cstPx`
  cstadmin=7,
  dose=3,
  rc1=41,
  nc1=486, 
  a=4,
  b=129,
  c=28,
  d=108
)

results <- jags(
  data = data,
  parameters.to.save = c("p1", "p2", "costtrt", "costctl"),
  model.file = model_code,
  n.chains = 1,
  n.iter=1
)


results
```

# Stochastic decision tree

This is the model on pp 59-60.

```{r stochastic_decision_tree}

model_code <- "
model{
  lnRR ~ dnorm(theta, prec)                  # Distribution for ln(Relative Risk)
  theta <- log( (a/(a+b)) / (c/(c+d)) )
  prec <- 1/( (1/a) - (1/(a+b)) + (1/c) - (1/(c+d)) )
  
  p1 ~ dbeta(alpha, beta)                    # Distribution for Prob(Infection/NoPx)
  alpha <- rc1
  beta <- nc1 - rc1
  
  p2 <- exp(lnRR) * p1                       # Distribution for Prob(Infection/Px)
  
  loswd ~ dnorm(mnloswd, precwd)             # Distribution for length of stay with infection
  precwd <- 1/pow(sdloswd/sqrt(numwd), 2)
  
  losnwd ~ dnorm(mnlosnwd, precnwd)          # Distribution for length of stay w/o infection
  precnwd <- 1/pow(sdlosnwd/sqrt(numnwd), 2)
  
  cstadmin ~ dunif(4, 10)                    # Px administration
  
  cst.trt <- (1-p2)*((cstPx + cstadmin)*3 + (losnwd*cstnwd)) + p2*((cstPx + cstadmin)*3 + (loswd*cstwd)) # Total cost (payoff) Px
  
  cst.ctl <- (1-p1)*(losnwd*cstnwd) + p1*(loswd*cstwd) # Total cost (payoff) No Rx
  
  diff.cost <- cst.trt - cst.ctl             # Difference in cost
}" %>% textConnection()

data <- list(
  rc1=41, nc1=486, cstwd=163.03, cstnwd=107.26,
  mnloswd=8.8, sdloswd=3.5,
  mnlosnwd=6.7, sdlosnwd=7.1,
  numwd=41, numnwd=445,
  cstPx=5.67,
  # rt=4, nt=133, rc=28, nc=136,  # Unused variables
  a=4, b=129, c=28, d=108
)

parameters_to_save <- c("cst.trt", "cst.ctl", "diff.cost")

results <- jags(data = data,
            # inits = initial_values,
            parameters.to.save = parameters_to_save,
            model.file = model_code,
            n.chains = 1, # length(initial_values),
            n.adapt = 100,
            n.iter = 50000,
            n.burnin = 20000)

results_summary <- summary(results) %>% as.data.frame()

results_summary

```
```{r plot_stochastic_results}
plot(results)
```

# Code for Exercises

## `Model_1_decision_model_odc.txt`

This is the code for Exercise 3.1, a deterministic decision tree comparing the use of prophylactic neuaminidase inhibitors (NIs) to standard care for influenza.

```{r model_1_decision_model}

model_code <- "model
{ 

  # DECISION MODEL
  costtrt <- ((1-p2) *(cdoc+cdrug) +p2* (cdoc+(cdrug)+cflu))
  costctl <- ((1-p1)*(cdoc)+p1*(cdoc+cflu))
  diff.cost <- costtrt-costctl

}" %>% textConnection

#DATA

data <- list(
  cdrug=118,    # cost of neuraminidase treatment
  cdoc=19,      # cost of visit to GP
  cflu=100,     # cost of treating flu
  p1=0.05,      # probability of contracting flu under standard care
  p2=0.03       # probability of contracting flu under NI prophylaxis				   
)

#RESULTS

results <- jags(
  data = data,
  # inits = NA,
  parameters.to.save = c("cdrug", "cdoc", "cflu", "p1", "p2",
                         "costtrt", "costctl", "diff.cost"),
  model.file = model_code,
  n.chains = 1,
  n.iter=1
)


results

```


