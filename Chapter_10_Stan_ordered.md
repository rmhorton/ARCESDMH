Chapter 10: Markov models
================
Bob
2025-04-29

Adapted from `Chapter_10.Rmd`. Suppose you are tasked for an analysis
“using the inferred Fluticasone treatment outcome rates as Seretide
treatment outcome priors.”

# Example 10.2 revisited (p 203)

``` r
# We need to do some munging to create an R data structure with the
# correct dimensions. First we make an R version of the `r` 3d array,
# using the data as it is printed in the text:
rr=structure(
  .Data=c(                    # Seretide
    210,     60,    0,  1,   1,   # Row 1 (STW)
     88,    641,    0,  4,  13,   # Row 2 (UTW)
      0,        0,  0,  0,   0,   # Row 3 (Hex)
      1,        0,  0,  0,   1,   # Row 4 (Pex)
    
                              # Fluticasone
     66,   32,  0,  0,   2,   # Row 1 (STW)
     42,  752,  0,  5,  20,   # Row 2 (UTW)
      0,    0,  0,  0,   0,   # Row 3 (Hex)
      0,    4,  0,  1,   0    # Row 4 (Pex)
    ), 
    .Dim=c(5,4,2)             # Matrix dimensions # 2,4,5
)

# The Seretide matrix is t(r[,,1]), and the Fluticasone matrix is t(r[,,2])

# Now we need to shift the values around to the arrangement JAGS expects. 
# Start with a 3d array full of placeholder values:
jr <- structure(
  .Data=rep(-1, 2*4*5),     # -1 can't really happen
  .Dim=c(2,4,5)             # Matrix dimensions
)

# Now copy in the numbers from the R array:
for (tmt in 1:2){
  for (i in 1:4){
    for (j in 1:5){
      jr[tmt, i, j] <- rr[j, i, tmt]
    }
  }
}

## The row totals need to be swapped and flipped (row major order) to match the `r` array.
## Since this is 2d data we can just use a matrix:
jn <- matrix(
    c(272,746,0,2,
      100,819,0,5),
    nrow=2, byrow=TRUE
)

prior <- structure(           # Dirichlet priors all = 1
  .Data=rep(1, 4*5), 
    .Dim=c(4,5)
)
```

Work problem in `Stan`. Methods taken from
<https://github.com/WinVector/Examples/blob/main/MetaAnalysis/Amlodipine/ExaminingMetaAnalysis.qmd>
.

``` r
library(rstan)
library(jsonlite)
```

``` r
stan_code <- "
data {
  int<lower=1> nt;  // treatments: 1=Seretide, 2=Fluticasone
  int<lower=1> ni;  // four non-absorbing states (sources)
  int<lower=1> nj;  // five overall states (destinations)
  array[nt, ni, nj] int<lower=0> r;
  array[ni] vector<lower=0>[nj] prior;
}
parameters {
  array[nt, ni] simplex[nj] pi;
}
transformed parameters {
  array[ni] vector<lower=0>[nj] post_2_i;
  for (i in 1:ni) {
     for (j in 1:nj) {
        post_2_i[i][j] = nj * pi[2, i][j];   // <-- posterior scaled
     }
  }
}
model {
  for (i in 1:ni) {    // four non-absorbing states
    // 2=Fluticasone
    r[2, i, ] ~ multinomial(pi[2, i]);    // multinomial data, total infferred from LHS
    pi[2, i] ~ dirichlet(prior[i]);       // Dirichlet prior
    // 1=Seretide
    r[1, i, ] ~ multinomial(pi[1, i]);    // multinomial data, total infferred from LHS
    pi[1, i] ~ dirichlet(post_2_i[i]);    // Fluticasone as prior (scaled)  <------
  }
}
"
```

``` r
stan_data <- list(
  nt = dim(jr)[[1]],
  ni = dim(jr)[[2]],
  nj = dim(jr)[[3]],
  r = array(jr, dim = dim(jr)),  # make sure array so shape info goes through JSON correctly
  prior = array(prior, dim = dim(prior))
)
```

``` r
sample <- stan(
  model_code = stan_code,  # Stan program
  data = stan_data,           # named list of data
  chains = 4,                 # number of Markov chains, 1 to debug
  warmup = 2000,              # number of warmup iterations per chain
  iter = 4000,                # total number of iterations per chain
  cores = 4,                  # number of cores (could use one per chain)
  refresh = 0,                # no progress shown
)
```

``` r
sample
```

    ## Inference for Stan model: anon_model.
    ## 4 chains, each with iter=4000; warmup=2000; thin=1; 
    ## post-warmup draws per chain=2000, total post-warmup draws=8000.
    ## 
    ##                  mean se_mean   sd     2.5%     25%     50%     75%   97.5%
    ## pi[1,1,1]        0.77    0.00 0.03     0.72    0.75    0.77    0.79    0.82
    ## pi[1,1,2]        0.22    0.00 0.03     0.17    0.21    0.22    0.24    0.27
    ## pi[1,1,3]        0.00    0.00 0.00     0.00    0.00    0.00    0.00    0.00
    ## pi[1,1,4]        0.00    0.00 0.00     0.00    0.00    0.00    0.01    0.01
    ## pi[1,1,5]        0.00    0.00 0.00     0.00    0.00    0.00    0.01    0.01
    ## pi[1,2,1]        0.12    0.00 0.01     0.10    0.11    0.12    0.12    0.14
    ## pi[1,2,2]        0.86    0.00 0.01     0.83    0.85    0.86    0.87    0.88
    ## pi[1,2,3]        0.00    0.00 0.00     0.00    0.00    0.00    0.00    0.00
    ## pi[1,2,4]        0.01    0.00 0.00     0.00    0.00    0.00    0.01    0.01
    ## pi[1,2,5]        0.02    0.00 0.00     0.01    0.01    0.02    0.02    0.03
    ## pi[1,3,1]        0.20    0.00 0.22     0.00    0.02    0.13    0.32    0.76
    ## pi[1,3,2]        0.20    0.00 0.22     0.00    0.02    0.12    0.32    0.75
    ## pi[1,3,3]        0.20    0.00 0.22     0.00    0.02    0.12    0.32    0.77
    ## pi[1,3,4]        0.20    0.00 0.22     0.00    0.02    0.12    0.32    0.76
    ## pi[1,3,5]        0.20    0.00 0.22     0.00    0.02    0.12    0.32    0.76
    ## pi[1,4,1]        0.26    0.00 0.17     0.02    0.13    0.23    0.37    0.65
    ## pi[1,4,2]        0.30    0.00 0.18     0.03    0.16    0.28    0.42    0.71
    ## pi[1,4,3]        0.06    0.00 0.10     0.00    0.00    0.01    0.08    0.34
    ## pi[1,4,4]        0.11    0.00 0.13     0.00    0.01    0.07    0.17    0.45
    ## pi[1,4,5]        0.26    0.00 0.17     0.02    0.12    0.23    0.36    0.65
    ## pi[2,1,1]        0.64    0.00 0.04     0.55    0.61    0.64    0.67    0.72
    ## pi[2,1,2]        0.31    0.00 0.04     0.23    0.28    0.31    0.34    0.39
    ## pi[2,1,3]        0.01    0.00 0.01     0.00    0.00    0.01    0.01    0.03
    ## pi[2,1,4]        0.02    0.00 0.01     0.00    0.01    0.01    0.02    0.04
    ## pi[2,1,5]        0.03    0.00 0.02     0.01    0.02    0.03    0.04    0.07
    ## pi[2,2,1]        0.05    0.00 0.01     0.04    0.05    0.05    0.06    0.07
    ## pi[2,2,2]        0.91    0.00 0.01     0.89    0.90    0.91    0.92    0.93
    ## pi[2,2,3]        0.00    0.00 0.00     0.00    0.00    0.00    0.00    0.00
    ## pi[2,2,4]        0.01    0.00 0.00     0.00    0.01    0.01    0.01    0.02
    ## pi[2,2,5]        0.03    0.00 0.01     0.02    0.02    0.03    0.03    0.04
    ## pi[2,3,1]        0.20    0.00 0.16     0.01    0.07    0.16    0.30    0.59
    ## pi[2,3,2]        0.20    0.00 0.16     0.01    0.07    0.16    0.29    0.58
    ## pi[2,3,3]        0.20    0.00 0.16     0.01    0.07    0.16    0.29    0.60
    ## pi[2,3,4]        0.20    0.00 0.16     0.01    0.07    0.16    0.29    0.60
    ## pi[2,3,5]        0.20    0.00 0.16     0.01    0.07    0.16    0.29    0.61
    ## pi[2,4,1]        0.17    0.00 0.10     0.02    0.09    0.15    0.23    0.41
    ## pi[2,4,2]        0.42    0.00 0.13     0.17    0.32    0.42    0.52    0.68
    ## pi[2,4,3]        0.08    0.00 0.07     0.00    0.03    0.06    0.12    0.28
    ## pi[2,4,4]        0.16    0.00 0.10     0.03    0.09    0.14    0.22    0.39
    ## pi[2,4,5]        0.17    0.00 0.10     0.02    0.09    0.15    0.23    0.42
    ## post_2_i[1,1]    3.18    0.00 0.22     2.74    3.03    3.18    3.33    3.61
    ## post_2_i[1,2]    1.54    0.00 0.22     1.13    1.39    1.54    1.69    1.97
    ## post_2_i[1,3]    0.04    0.00 0.04     0.00    0.01    0.03    0.06    0.14
    ## post_2_i[1,4]    0.08    0.00 0.06     0.01    0.04    0.07    0.11    0.22
    ## post_2_i[1,5]    0.16    0.00 0.08     0.04    0.10    0.14    0.20    0.34
    ## post_2_i[2,1]    0.27    0.00 0.04     0.20    0.24    0.26    0.29    0.35
    ## post_2_i[2,2]    4.55    0.00 0.05     4.45    4.52    4.56    4.59    4.65
    ## post_2_i[2,3]    0.01    0.00 0.01     0.00    0.00    0.01    0.01    0.02
    ## post_2_i[2,4]    0.04    0.00 0.02     0.02    0.03    0.04    0.05    0.08
    ## post_2_i[2,5]    0.13    0.00 0.03     0.08    0.11    0.13    0.15    0.19
    ## post_2_i[3,1]    1.02    0.02 0.80     0.05    0.37    0.81    1.48    2.97
    ## post_2_i[3,2]    0.99    0.02 0.79     0.04    0.36    0.81    1.45    2.91
    ## post_2_i[3,3]    0.98    0.02 0.81     0.03    0.33    0.78    1.43    2.99
    ## post_2_i[3,4]    1.00    0.02 0.81     0.05    0.36    0.79    1.47    3.00
    ## post_2_i[3,5]    1.00    0.02 0.81     0.05    0.35    0.81    1.45    3.04
    ## post_2_i[4,1]    0.83    0.01 0.52     0.11    0.43    0.74    1.13    2.06
    ## post_2_i[4,2]    2.10    0.01 0.67     0.86    1.62    2.08    2.58    3.40
    ## post_2_i[4,3]    0.42    0.01 0.37     0.02    0.14    0.32    0.60    1.38
    ## post_2_i[4,4]    0.82    0.01 0.49     0.13    0.44    0.72    1.10    1.97
    ## post_2_i[4,5]    0.83    0.01 0.52     0.12    0.44    0.74    1.13    2.08
    ## lp__          -990.69    0.17 5.07 -1001.44 -993.94 -990.39 -987.07 -981.60
    ##               n_eff Rhat
    ## pi[1,1,1]      3570    1
    ## pi[1,1,2]      3605    1
    ## pi[1,1,3]      7670    1
    ## pi[1,1,4]      3492    1
    ## pi[1,1,5]      3654    1
    ## pi[1,2,1]      3654    1
    ## pi[1,2,2]      3450    1
    ## pi[1,2,3]      7561    1
    ## pi[1,2,4]      3200    1
    ## pi[1,2,5]      3854    1
    ## pi[1,3,1]      3058    1
    ## pi[1,3,2]      2881    1
    ## pi[1,3,3]      2324    1
    ## pi[1,3,4]      3292    1
    ## pi[1,3,5]      3291    1
    ## pi[1,4,1]      3334    1
    ## pi[1,4,2]      2689    1
    ## pi[1,4,3]      4441    1
    ## pi[1,4,4]      3272    1
    ## pi[1,4,5]      4317    1
    ## pi[2,1,1]      3700    1
    ## pi[2,1,2]      3510    1
    ## pi[2,1,3]      1864    1
    ## pi[2,1,4]      3224    1
    ## pi[2,1,5]      3533    1
    ## pi[2,2,1]      3102    1
    ## pi[2,2,2]      3386    1
    ## pi[2,2,3]      1774    1
    ## pi[2,2,4]      3498    1
    ## pi[2,2,5]      3682    1
    ## pi[2,3,1]      2153    1
    ## pi[2,3,2]      2118    1
    ## pi[2,3,3]      1622    1
    ## pi[2,3,4]      2151    1
    ## pi[2,3,5]      2522    1
    ## pi[2,4,1]      2830    1
    ## pi[2,4,2]      2490    1
    ## pi[2,4,3]      2119    1
    ## pi[2,4,4]      2500    1
    ## pi[2,4,5]      2961    1
    ## post_2_i[1,1]  3700    1
    ## post_2_i[1,2]  3510    1
    ## post_2_i[1,3]  1864    1
    ## post_2_i[1,4]  3224    1
    ## post_2_i[1,5]  3533    1
    ## post_2_i[2,1]  3102    1
    ## post_2_i[2,2]  3386    1
    ## post_2_i[2,3]  1774    1
    ## post_2_i[2,4]  3498    1
    ## post_2_i[2,5]  3682    1
    ## post_2_i[3,1]  2153    1
    ## post_2_i[3,2]  2118    1
    ## post_2_i[3,3]  1622    1
    ## post_2_i[3,4]  2151    1
    ## post_2_i[3,5]  2522    1
    ## post_2_i[4,1]  2830    1
    ## post_2_i[4,2]  2490    1
    ## post_2_i[4,3]  2119    1
    ## post_2_i[4,4]  2500    1
    ## post_2_i[4,5]  2961    1
    ## lp__            865    1
    ## 
    ## Samples were drawn using NUTS(diag_e) at Wed May 21 13:54:23 2025.
    ## For each parameter, n_eff is a crude measure of effective sample size,
    ## and Rhat is the potential scale reduction factor on split chains (at 
    ## convergence, Rhat=1).

``` r
sample |>
  as.data.frame() |>
  head() |>
  knitr::kable()
```

| pi\[1,1,1\] | pi\[2,1,1\] | pi\[1,2,1\] | pi\[2,2,1\] | pi\[1,3,1\] | pi\[2,3,1\] | pi\[1,4,1\] | pi\[2,4,1\] | pi\[1,1,2\] | pi\[2,1,2\] | pi\[1,2,2\] | pi\[2,2,2\] | pi\[1,3,2\] | pi\[2,3,2\] | pi\[1,4,2\] | pi\[2,4,2\] | pi\[1,1,3\] | pi\[2,1,3\] | pi\[1,2,3\] | pi\[2,2,3\] | pi\[1,3,3\] | pi\[2,3,3\] | pi\[1,4,3\] | pi\[2,4,3\] | pi\[1,1,4\] | pi\[2,1,4\] | pi\[1,2,4\] | pi\[2,2,4\] | pi\[1,3,4\] | pi\[2,3,4\] | pi\[1,4,4\] | pi\[2,4,4\] | pi\[1,1,5\] | pi\[2,1,5\] | pi\[1,2,5\] | pi\[2,2,5\] | pi\[1,3,5\] | pi\[2,3,5\] | pi\[1,4,5\] | pi\[2,4,5\] | post_2_i\[1,1\] | post_2_i\[2,1\] | post_2_i\[3,1\] | post_2_i\[4,1\] | post_2_i\[1,2\] | post_2_i\[2,2\] | post_2_i\[3,2\] | post_2_i\[4,2\] | post_2_i\[1,3\] | post_2_i\[2,3\] | post_2_i\[3,3\] | post_2_i\[4,3\] | post_2_i\[1,4\] | post_2_i\[2,4\] | post_2_i\[3,4\] | post_2_i\[4,4\] | post_2_i\[1,5\] | post_2_i\[2,5\] | post_2_i\[3,5\] | post_2_i\[4,5\] | lp\_\_ |
|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| 0.7842918 | 0.5847532 | 0.1166977 | 0.0551773 | 0.0581608 | 0.1019976 | 0.1281945 | 0.1916442 | 0.2067212 | 0.3520835 | 0.8569922 | 0.9170491 | 0.0973141 | 0.1241519 | 0.5541379 | 0.6282279 | 0.0053443 | 0.0097817 | 0.0e+00 | 0.0027175 | 0.0035763 | 0.0663458 | 0.0548506 | 0.0085913 | 0.0005656 | 0.0082978 | 0.0049908 | 0.0023627 | 0.8263464 | 0.6643140 | 0.0004372 | 0.0304815 | 0.0030771 | 0.0450837 | 0.0213193 | 0.0226934 | 0.0146024 | 0.0431906 | 0.2623797 | 0.1410552 | 2.923766 | 0.2758866 | 0.5099882 | 0.9582209 | 1.760418 | 4.585245 | 0.6207596 | 3.141139 | 0.0489086 | 0.0135874 | 0.3317289 | 0.0429565 | 0.0414890 | 0.0118135 | 3.3215702 | 0.1524073 | 0.2254187 | 0.1134672 | 0.2159531 | 0.7052761 | -992.5490 |
| 0.7627412 | 0.7086608 | 0.1172792 | 0.0607778 | 0.0076952 | 0.0924872 | 0.2962850 | 0.0930517 | 0.2346667 | 0.2540013 | 0.8630963 | 0.8888617 | 0.1219478 | 0.1818007 | 0.5601903 | 0.5878033 | 0.0000000 | 0.0060512 | 1.0e-06 | 0.0007871 | 0.5551859 | 0.3875562 | 0.1148481 | 0.2012195 | 0.0019807 | 0.0157647 | 0.0062160 | 0.0258261 | 0.0162483 | 0.0207797 | 0.0000000 | 0.0566131 | 0.0006114 | 0.0155220 | 0.0134074 | 0.0237474 | 0.2989227 | 0.3173762 | 0.0286766 | 0.0613124 | 3.543304 | 0.3038889 | 0.4624358 | 0.4652585 | 1.270006 | 4.444308 | 0.9090037 | 2.939017 | 0.0302561 | 0.0039353 | 1.9377810 | 1.0060976 | 0.0788234 | 0.1291305 | 0.1038985 | 0.2830653 | 0.0776100 | 0.1187370 | 1.5868809 | 0.3065622 | -996.4050 |
| 0.7606048 | 0.6528799 | 0.1200323 | 0.0660456 | 0.1010615 | 0.3378966 | 0.0458347 | 0.0906623 | 0.2202483 | 0.2808431 | 0.8600311 | 0.9077833 | 0.1998499 | 0.0348166 | 0.3665036 | 0.5993476 | 0.0000000 | 0.0075998 | 2.3e-05 | 0.0038940 | 0.1438158 | 0.1716971 | 0.1932558 | 0.1142840 | 0.0019180 | 0.0109413 | 0.0048244 | 0.0030900 | 0.5159174 | 0.4009530 | 0.0000005 | 0.0227202 | 0.0172289 | 0.0477359 | 0.0150892 | 0.0191871 | 0.0393553 | 0.0546367 | 0.3944053 | 0.1729860 | 3.264400 | 0.3302282 | 1.6894832 | 0.4533116 | 1.404216 | 4.538916 | 0.1740830 | 2.996738 | 0.0379990 | 0.0194701 | 0.8584856 | 0.5714200 | 0.0547063 | 0.0154501 | 2.0047649 | 0.1136008 | 0.2386796 | 0.0959354 | 0.2731833 | 0.8649298 | -990.1802 |
| 0.7876636 | 0.6068281 | 0.1067148 | 0.0430133 | 0.7069894 | 0.3657774 | 0.5847017 | 0.2930701 | 0.2108094 | 0.3612822 | 0.8754889 | 0.9240340 | 0.0589687 | 0.2556730 | 0.0523620 | 0.3448518 | 0.0000000 | 0.0042142 | 6.5e-06 | 0.0011947 | 0.0630807 | 0.0688171 | 0.0740018 | 0.1643870 | 0.0010542 | 0.0094289 | 0.0024826 | 0.0085183 | 0.1417180 | 0.2062309 | 0.0942080 | 0.1104967 | 0.0004729 | 0.0182467 | 0.0153071 | 0.0232398 | 0.0292432 | 0.1035017 | 0.1947264 | 0.0871944 | 3.034140 | 0.2150664 | 1.8288869 | 1.4653504 | 1.806411 | 4.620170 | 1.2783650 | 1.724259 | 0.0210709 | 0.0059734 | 0.3440854 | 0.8219348 | 0.0471445 | 0.0425915 | 1.0311543 | 0.5524837 | 0.0912335 | 0.1161989 | 0.5175085 | 0.4359722 | -983.4914 |
| 0.7718997 | 0.5961971 | 0.1264674 | 0.0426252 | 0.1022406 | 0.3310798 | 0.4699163 | 0.3466413 | 0.2240515 | 0.3571860 | 0.8557091 | 0.9252391 | 0.0601056 | 0.0762191 | 0.0887327 | 0.3595888 | 0.0000000 | 0.0052828 | 1.7e-05 | 0.0031742 | 0.5471314 | 0.2461607 | 0.0109209 | 0.0351463 | 0.0017700 | 0.0216839 | 0.0030134 | 0.0070464 | 0.1411444 | 0.0443251 | 0.1449868 | 0.1524775 | 0.0022787 | 0.0196502 | 0.0147930 | 0.0219152 | 0.1493781 | 0.3022153 | 0.2854433 | 0.1061461 | 2.980986 | 0.2131258 | 1.6553992 | 1.7332067 | 1.785930 | 4.626195 | 0.3810955 | 1.797944 | 0.0264139 | 0.0158709 | 1.2308033 | 0.1757316 | 0.1084194 | 0.0352320 | 0.2216254 | 0.7623874 | 0.0982510 | 0.1095759 | 1.5110767 | 0.5307304 | -981.7518 |
| 0.7729817 | 0.5642188 | 0.1205921 | 0.0465164 | 0.2182044 | 0.1417465 | 0.5162219 | 0.4917939 | 0.2234908 | 0.3599615 | 0.8606993 | 0.9176437 | 0.0130933 | 0.0625750 | 0.0520371 | 0.2698569 | 0.0000000 | 0.0052604 | 0.0e+00 | 0.0027563 | 0.5736582 | 0.4518981 | 0.0049776 | 0.0489750 | 0.0014810 | 0.0267319 | 0.0049287 | 0.0054937 | 0.0001477 | 0.1084367 | 0.1226081 | 0.1146078 | 0.0020464 | 0.0438273 | 0.0137799 | 0.0275899 | 0.1948964 | 0.2353436 | 0.3041553 | 0.0747664 | 2.821094 | 0.2325820 | 0.7087326 | 2.4589697 | 1.799807 | 4.588218 | 0.3128750 | 1.349285 | 0.0263022 | 0.0137817 | 2.2594905 | 0.2448749 | 0.1336596 | 0.0274686 | 0.5421837 | 0.5730389 | 0.2191367 | 0.1379493 | 1.1767182 | 0.3738318 | -984.9506 |
